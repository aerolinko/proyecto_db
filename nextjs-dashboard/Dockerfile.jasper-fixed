FROM retriever/jasperserver:latest

# Instalar Java 11 y herramientas necesarias
RUN apt-get update && apt-get install -y \
    openjdk-11-jdk \
    ant \
    && rm -rf /var/lib/apt/lists/*

# Configurar variables de entorno de Java
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH=$JAVA_HOME/bin:$PATH

# Crear archivos de configuración faltantes
RUN mkdir -p /usr/src/jasperreports-server/buildomatic/sample_conf && \
    echo 'appServerType=tomcat' > /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties && \
    echo 'dbType=postgresql' >> /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties && \
    echo 'dbHost=postgres' >> /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties && \
    echo 'dbPort=5432' >> /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties && \
    echo 'dbUsername=jasper' >> /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties && \
    echo 'dbPassword=jasper123' >> /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties && \
    echo 'js.dbName=jasperdb' >> /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties && \
    echo 'appServerDir=/usr/local/tomcat' >> /usr/src/jasperreports-server/buildomatic/sample_conf/_master.properties

# Crear directorios y archivos faltantes
RUN mkdir -p /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF && \
    mkdir -p /opt/jasperserver/apache-tomcat/logs && \
    mkdir -p /usr/src/jasperreports-server/buildomatic/usr/local/tomcat/lib && \
    touch /opt/jasperserver/apache-tomcat/logs/catalina.out

# Crear archivo de propiedades de Quartz
RUN echo '# Quartz configuration file' > /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF/js.quartz.properties.template && \
    echo 'org.quartz.scheduler.instanceName=JasperScheduler' >> /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF/js.quartz.properties.template && \
    echo 'org.quartz.scheduler.instanceId=AUTO' >> /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF/js.quartz.properties.template && \
    echo 'org.quartz.threadPool.class=org.quartz.simpl.SimpleThreadPool' >> /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF/js.quartz.properties.template && \
    echo 'org.quartz.threadPool.threadCount=5' >> /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF/js.quartz.properties.template && \
    echo 'org.quartz.threadPool.threadPriority=5' >> /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF/js.quartz.properties.template && \
    echo 'org.quartz.jobStore.class=org.quartz.simpl.RAMJobStore' >> /opt/jasperserver/apache-tomcat/webapps/jasperserver/WEB-INF/js.quartz.properties.template

# Crear enlace simbólico para tools.jar si no existe
RUN if [ ! -f "$JAVA_HOME/lib/tools.jar" ]; then \
        ln -s $JAVA_HOME/lib/tools.jar $JAVA_HOME/jre/lib/tools.jar 2>/dev/null || true; \
    fi

EXPOSE 8080 